rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to get user ID
    function getUserId() {
      return request.auth.uid;
    }
    
    // Helper function to check if user is owner of the task
    function isOwner(task) {
      return task.ownerId == getUserId();
    }
    
    // Helper function to check if user is collaborator (in memberIds)
    function isCollaborator(task) {
      return getUserId() in (task.memberIds != null ? task.memberIds : []);
    }
    
    // Helper function to check if user is assignee
    function isAssignee(task) {
      return task.assigneeId == getUserId();
    }
    
    // Helper function to check if user has access to the task
    function hasTaskAccess(task) {
      return isOwner(task) || isCollaborator(task) || isAssignee(task);
    }
    
    // Helper function to check if user is admin of a project
    function isProjectAdmin(task) {
      return task.team != null && task.team.hasAny([{'userId': getUserId(), 'role': 'admin'}]);
    }
    
    // ============================================
    // TASKS COLLECTION
    // ============================================
    match /tasks/{taskId} {
      // TEMPORARY FOR DEVELOPMENT: Allow read all for client-side filtering
      // TODO: Implement proper queries with compound indexes
      allow read: if isAuthenticated();
      
      allow create: if isAuthenticated() && (
        request.resource.data.parentId == null ? (
          request.resource.data.ownerId == getUserId() &&
          request.resource.data.memberIds.hasAll([getUserId()])
        ) : (
          true
        )
      );
      
      allow update: if isAuthenticated() && (
        isOwner(resource.data) || 
        (isCollaborator(resource.data) && isProjectAdmin(resource.data))
      );
      
      allow delete: if isAuthenticated() && isOwner(resource.data);
    }
    
    // ============================================
    // TEAM_MEMBERS COLLECTION
    // ============================================
    match /team_members/{userId} {
      allow read: if isAuthenticated();
      
      allow create: if isAuthenticated() && userId == getUserId();
      
      allow update, delete: if isAuthenticated() && request.auth.token.role in ['superuser'];
    }
    
    // ============================================
    // MESSAGES COLLECTION
    // ============================================
    match /messages/{messageId} {
      allow read: if isAuthenticated();
      
      allow create: if isAuthenticated() && (
        request.resource.data.senderId == getUserId()
      );
      
      allow update, delete: if isAuthenticated() && request.auth.token.role in ['superuser'];
    }
  }
}
